version: '3.9'

# ========================================
# Production Deployment Example
# ========================================
# This example shows production deployment with:
# - Pre-built images from a registry (optional)
# - Persistent data volumes
# - Production environment variables
#
# Usage:
# 1. Copy this file: cp docker-compose.prod.example.yml docker-compose.override.yml
# 2. Customize the values below
# 3. Run: docker-compose up -d
#
# Note: This is a standalone deployment. For reverse proxy setups,
# configure your proxy (Traefik/Nginx/Caddy) to forward traffic to
# the exposed ports (8080 for frontend, 3000 for API).
# ========================================

services:
  frontend:
    # Option 1: Use pre-built image from registry
    # image: ghcr.io/yourusername/urbangolf-frontend:latest

    # Option 2: Build locally (comment out 'image' above)
    build:
      context: .
      dockerfile: frontend/Dockerfile
      args:
        VITE_API_BASEURL: /api  # Or https://yourdomain.com/api for external API

    restart: unless-stopped
    ports:
      - "8080:80"
    depends_on:
      - backend

  backend:
    # Option 1: Use pre-built image from registry
    # image: ghcr.io/yourusername/urbangolf-backend:latest

    # Option 2: Build locally (comment out 'image' above)
    build:
      context: .
      dockerfile: backend/Dockerfile

    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      # Set to your actual domain or IP
      ALLOWED_ORIGINS: http://localhost:8080
    depends_on:
      postgres:
        condition: service_healthy

  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      # Use named volume or bind mount to persist data
      - postgres_data:/var/lib/postgresql/data
      # Or use a specific path on your host:
      # - /path/to/data:/var/lib/postgresql/data
      - ./backend/db/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}']
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
